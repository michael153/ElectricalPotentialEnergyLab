<!DOCTYPE html>
<html lang = "en-us">
	<head>
		<meta charset = "UTF-8">
		<title>Electrical Potential Energy Lab</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="js/Circle.js"></script>
		<script src="js/Line.js"></script>
		<script src="js/RKDemo.js"></script>
		<script src="js/potential.js"></script>
		<style>
			body {
				font-family: "Arial", Arial, serif;
				font-size: 14px;
			}
		</style>
	</head>
	<body>
		<div id = "top" align = "center" style = "vertical-align: middle">
			<input type="submit" id = 'ruler' value="Show Ruler"/>

			<input type="range" min="5" max="20" value="5" class="slider" id="dx">
			<label id = "dxLabel">Simulation Speed = </label><output id="dxOutput">5</output>
			
			<input type="range" min="0" max="700" value="0" class="slider" id="vx">
			<label id = "dxLabel">vx = </label><output id="vxOutput">0</output>
			
			<input type="range" min="0" max="700" value="0" class="slider" id="vy">
			<label id = "dyLabel">vy = </label><output id="vyOutput">0</output>
			
			<input type="submit" id = 'go' value="Go"/>
			<input type="submit" id = 'restart' value="Reset"/>
		</div>
		<br><br>
		<div id = "container" align = "center">
			<canvas id="panel" width="900" height="600" style="border:1px solid #000000;"></canvas>
		</div>
	</body>

	<script>
		function toDegrees(angle) {
			return angle * (180 / Math.PI);
		}

		function toRadians(angle) {
			return angle * (Math.PI / 180);
		}

		function getDist(x1, y1) {
			return Math.sqrt(x1*x1 + y1*y1);
		}

		function swapEndpoints() {
			var endX = rulerX + rulerLength*Math.cos(toRadians(rulerAngToHorizontal));
			if (endX < rulerX) {
				rulerX = endX;
				rulerY = rulerY + rulerLength*Math.sin(toRadians(rulerAngToHorizontal));
				rulerAngToHorizontal = 180 - rulerAngToHorizontal;
			}
		}

		function getAngle(x, y) {
			if (x === 0) {
				if (y > 0) return 90.0;
				else return 270.0;
			}
			else if (y === 0) {
				if (x < 0) return 180.0;
				else return 0.0;
			}
			else {
				ang = toDegrees(Math.atan(y/x));
				if (y <= 0 && x >= 0)
					ang += 360;
				else if (y <= 0 && x <= 0)
					ang += 180;
				else if (x <= 0 && y >= 0)
					ang += 180;
				return ang;
			}
		}

		function clickedRuler(x, y) {
			var rulerDx = x - rulerX;
			var rulerDy = y - rulerY;
			var curAngle = getAngle(rulerDx, rulerDy);
			return ((Math.abs(curAngle - rulerAngToHorizontal) < 2) && getDist(rulerDx, rulerDy) <= rulerLength);
		}

		function clickedRulerStart(x, y) {
			return getDist(x - rulerX, y - rulerY) < 10;
		}

		function clickedRulerEnd(x, y) {
			return (getDist(x - (rulerX + rulerLength*Math.cos(toRadians(rulerAngToHorizontal))),
							y - (rulerY + rulerLength*Math.sin(toRadians(rulerAngToHorizontal)))) < 10);
		}

		document.getElementById("ruler").onclick = function() {
			showRuler = !showRuler;
			if (showRuler) {
				console.log("Draw Ruler");
				drawRuler(context);
			}
			else {
				repaint(context);
			}
		};
	</script>


	<!-- Window Setup -->
	<script>
		var canvas = document.getElementById("panel");
		var context = canvas.getContext("2d");

		window.onload = function() {
			console.log("Calling init()...");
			init(context);
		}
	</script>

	<!-- Inputs Values -->
	<script>
		var dx__ = document.getElementById("dx").value;
		var vx__ = document.getElementById("vx").value;
		var vy__ = document.getElementById("vy").value;

		document.getElementById("dx").oninput = function() {
			dx__ = document.getElementById("dx").value;
			document.getElementById('dxOutput').innerHTML = dx__;
			dx = dx__;
		};
		document.getElementById("vx").oninput = function() {
			vx__ = document.getElementById("vx").value;
			document.getElementById('vxOutput').innerHTML = vx__;
			vx = vx__;
		};
		document.getElementById("vy").oninput = function() {
			vy__ = document.getElementById("vy").value;
			document.getElementById('vyOutput').innerHTML = vy__;
			vy = vy__;
		};
	</script>
	
	<!-- All the listeners -->
	<script>
		var start = {x: 0, y: 0};
		var end = {x: 0, y: 0};
		var bottomClicked = false;
		var topClicked = false;
		var flag = 0;

		canvas.addEventListener("mousedown", function(e) {
			start.x = e.pageX - this.offsetLeft;
			start.y = e.pageY - this.offsetTop;
			if (clickedRulerStart(start.x, start.y)) {
				rulerStartClicked = true;
				console.log("Clicked Ruler Start");
			}
			else if (clickedRulerEnd(start.x, start.y)) {
				rulerEndClicked = true;
				console.log("Clicked Ruler End");	
			}
			else if (clickedRuler(start.x, start.y)) {
				rulerClicked = true;
				rulerClickOffset = getDist(start.x - rulerX, start.y - rulerY);
				console.log("Ruler Clicked");
			}
			else if (withinBottomSphere(start.x, start.y))
				bottomClicked = true;
			else if (withinTopSphere(start.x, start.y))
				topClicked = true;
			flag = 1;
		}, false);
		
		canvas.addEventListener("mousemove", function(e) {
			if (flag === 1) {
				end.x = e.pageX - this.offsetLeft;
				end.y = e.pageY - this.offsetTop;
				if (bottomClicked) {
					updateBottomSphere(context, end.x, end.y);
					if (showRuler)
						drawRuler(context);
				}
				if (topClicked) {
					updateTopSphere(context, end.x, end.y);
					if (showRuler)
						drawRuler(context);
				}
				if (rulerEndClicked) {
					rulerAngToHorizontal = getAngle(end.x - rulerX, end.y - rulerY);
					rulerLength = getDist(end.x - rulerX, end.y - rulerY);
					repaint(context);
					drawRuler(context);
				}
				if (rulerStartClicked) {
					var originalEndX = rulerX + rulerLength*Math.cos(toRadians(rulerAngToHorizontal));
					var originalEndY = rulerY + rulerLength*Math.sin(toRadians(rulerAngToHorizontal));
					rulerLength = getDist(originalEndX - end.x, originalEndY - end.y);
					rulerAngToHorizontal = getAngle(originalEndX - end.x, originalEndY - end.y);
					rulerX = end.x;
					rulerY = end.y;
					repaint(context);
					drawRuler(context);
				}
				if (rulerClicked) {
					// console.log("New ruler x, y: " + rulerX + ", " + rulerY);
					rulerX = end.x - rulerClickOffset*Math.cos(toRadians(rulerAngToHorizontal));
					rulerY = end.y - rulerClickOffset*Math.sin(toRadians(rulerAngToHorizontal));
					repaint(context);
					drawRuler(context);
				}
			}
		}, false);
		
		canvas.addEventListener("mouseup", function(e) {
			// swapEndpoints();
			flag = 0;
			bottomClicked = false;
			topClicked = false;
			rulerClicked = false;
			rulerStartClicked = false;
			rulerEndClicked = false;
			resetHits();
		}, false);
	</script>

	<!-- Button actions -->
	<script>
		window.addEventListener('resize', function(e) {
			height = canvas.height;
			width = canvas.width;
			console.log("Canvas Size: " + height + " x " + width);
			iterateSimulation(canvas, context);
		})
		document.getElementById("go").onclick = function() {
			inAction = true;
			dx = dx__;
			vx = vx__;
			vy = vy__;

			simTimer = setInterval(function() {
				iterateSimulation(canvas, context)
			}, 0.5);
		};
		document.getElementById("restart").onclick = function() {
			inAction = false;
			isInit = false;
			showRuler = false;
			clearInterval(simTimer);
			hardReset(context);
			// Reset slider values
			// dx__ = defaultDx;
			// vx__ = defaultVx;
			// vy__ = defaultVy;
			// Reset initial dx, vx, vy as used in backend
			// dx = dx__;
			// vx = vx__;
			// vy = vy__;
			// Reset HTML values
			// document.getElementById('dx').value = dx__;
			// document.getElementById('vx').value = vx__;
			// document.getElementById('vy').value = vy__;
			// document.getElementById('dxOutput').innerHTML = dx__;
			// document.getElementById('vxOutput').innerHTML = vx__;
			// document.getElementById('vyOutput').innerHTML = vy__;
		};
	</script>
</html>